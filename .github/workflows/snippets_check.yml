ZONES=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?per_page=50" \
  -H "Authorization: Bearer $CF_API_TOKEN" \
  -H "Content-Type: application/json")

# 检查是否有域名
COUNT=$(echo "$ZONES" | jq '.result | length')
if [ "$COUNT" -eq 0 ]; then
  echo "No zones found. Please check your API token and permissions."
  exit 1
fi

# 遍历域名
echo "$ZONES" | jq -c '.result[] | {id: .id, name: .name}' | while read -r zone; do
  DOMAIN=$(echo "$zone" | jq -r '.name')
  ZONE_ID=$(echo "$zone" | jq -r '.id')

  RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/rulesets/capabilities" \
    -H "Authorization: Bearer $CF_API_TOKEN" \
    -H "Content-Type: application/json")

  SNIPPETS_COUNT=$(echo "$RESPONSE" | jq -r '.result[] | select(.id=="rulesets.snippets_rule_max") | .value')

  if [ -n "$SNIPPETS_COUNT" ]; then
    AVAILABLE="✅"
  else
    AVAILABLE="❌"
    SNIPPETS_COUNT="-"
  fi

  echo "| $DOMAIN | $ZONE_ID | $AVAILABLE | $SNIPPETS_COUNT |" >> snippets_status.md
done
